<?php
/**
 * @file
 * Code for the Business Portal Wizard feature.
 */

include_once 'sbp_wizard.features.inc';
include_once 'inc/sbp_wizard_email_form.inc';

/**
* Implements hook_menu().
*/
function sbp_wizard_menu(){
  $items = array();
  $items['labp/wizard-email'] = array(
    'title' => 'Email callback',
    'page callback' => 'sbp_email_process',
    'access arguments' => array('access content'),
    'type' => MENU_SUGGESTED_ITEM,
  );
  return $items;
}

/**
 * Callback for processing ajax form
 */
function sbp_email_process(){
  $module = 'email_example';
  $key = 'contact_message';
  $to = $_POST['email'];
  $from = variable_get('site_mail', 'no-reply@lacity.org');
  $params = $_POST;
  $language = language_default();
  $send = TRUE;

  // Check the form token and check the honeypot we put in.
  if (drupal_valid_token($_POST['form_token'])
    and !$_POST['emailCheck']) {
    print t('Good bye.');
    exit();
  }

  $result =  drupal_mail(
    'sbp_wizard',
    'wizard_results',
    $to,
    //user_preferred_language($account),
    language_default(),
    $params,
    $from, //
    $send
  );
  if ($result['result'] == TRUE) {
    print t('Your message has been sent.');
  }
  else {
    print t('There was a problem sending your message and it was not sent.');
  }
  exit();
}

/**
 * Impliments hook_mail()
 */
function sbp_wizard_mail($key, &$message, $params) {
  global $user;

  $options = array(
    'langcode' => $message['language']->language,
  );

  switch ($key) {
    // Send a simple message from the contact form.
    case 'wizard_results':
      $message['subject'] = t('E-mail sent from @site-name', array('@site-name' => variable_get('site_name', 'Drupal')), $options);
      // Note that the message body is an array, not a string.
      $message['body'][] = check_plain($params['message']);
      break;
  }
}

/**
 * Implements hook_entity_info_alter().
 */
function sbp_wizard_entity_info_alter(&$entity_info) {
  $entity_info['node']['view modes']['json'] = array(
    'label' => t('json'),
    'custom settings' => TRUE,
  );
}

/**
 * Implements hook_theme().
 */
function sbp_wizard_theme() {
  return array(
    'sbp_wizard_block' => array(
      'variables' => array('address_form' => NULL, 'email_form' => NULL),
      'template' => 'sbp-wizard-block',
    ),
  );
}

/**
 * Implements hook_block_info().
 */
function sbp_wizard_block_info() {
  $blocks = array();
  $blocks['wizard'] = array(
    'info' => t('Wizard Block'),
    'cache' => DRUPAL_CACHE_PER_ROLE,
  );
  return $blocks;
}

/**
 * Implements hook_block_view().
 */
function sbp_wizard_block_view($delta = '') {
  if (module_exists('labp_address_wizard')) {
    $address_form = drupal_get_form('labp_address_wizard_address_input');
    $address_form = drupal_render($address_form);
  } else {
    $address_form = '';
  }
  
  $email_form = drupal_get_form('sbp_wizard_email_form');
  $email_form = drupal_render($email_form);
  
  $block = array();
  switch ($delta) {
    case 'wizard':
      $block['subject'] = NULL;
      $block['content'] = theme('sbp_wizard_block', array('address_form'=>$address_form, 'email_form'=>$email_form));
      break;
  };
  return $block;
}
